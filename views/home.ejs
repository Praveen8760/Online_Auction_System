<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="icon" href="/image/brand_icon.svg">
    <link rel="stylesheet" href="/css/output.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
    <script src="https://unpkg.com/flowbite@1.6.5/dist/flowbite.min.js"></script>
    <!-- <link rel="stylesheet" href="/src/css/main.css"> -->

    <style>
        #shadow {
            box-shadow: inset 0 4px 6px rgba(0, 0, 0, 0.5);
        }
    </style>

</head>

<body class="bg-white-base">

    <!-- navbar -->
    <nav class="bg-white">
        <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
        <a href="/home" class="flex items-center space-x-9 rtl:space-x-reverse">
            <img src="image/brand_icon.svg" class="h-14 w-14 lg:w-[40px] lg:h-[40px]" alt="Flowbite Logo" />
            <span class="self-center text-2xl font-semibold whitespace-nowrap font-Custom">Bidding</span>
        </a>
        <div class="flex items-center md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse">
            <button type="button" class="flex text-sm rounded-full md:me-0" id="user-menu-button" aria-expanded="false" data-dropdown-toggle="user-dropdown" data-dropdown-placement="bottom">
            <img class="w-8 h-8 rounded-full" src="image/user.svg" alt="user photo">
            </button>
            <!-- Dropdown menu -->
            <div class="z-50 hidden my-4 left-10 text-base list-none bg-white divide-y rounded-lg shadow divide-primary" id="user-dropdown">
            <div class="px-4 py-3">
                <span class="block text-mobile-p lg:text-destop-p font-semibold text-dark"><%= user.fullname %></span>
                <span class="block text-sm  text-gray-500 truncate"><%= user.email %></span>
            </div>
            <ul class="py-2" aria-labelledby="user-menu-button">
                <li>
                <a href="/profile" class="block px-4 py-2 text-mobile-p text-gray-800 hover:bg-gray-100 font-Custom">Profile</a>
                </li>
                <li>
                <a href="/addProduct" class="block px-4 py-2 text-mobile-p text-gray-800 hover:bg-gray-100 font-Custom">Create Auction</a>
                </li>
                <li>
                <a href="/myBids" class="block px-4 py-2 text-mobile-p text-gray-800 hover:bg-gray-100 font-Custom">Watch List</a>
                </li>
                <li>
                <a href="/logout" class="block px-4 py-2 text-mobile-p text-gray-800 hover:bg-gray-100 font-Custom">Sign out</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- grid -->
    <main class="h-dvh w-auto mx-6 mt-24 lg:mx-24 flex justify-center">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="grid gap-2">
                <div>
                    <img class="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/masonry/image.jpg" alt="">
                </div>
                <div>
                    <img class="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/masonry/image-1.jpg" alt="">
                </div>
            </div>
            <div class="grid gap-2">
                <div>
                    <img class="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/masonry/image-3.jpg" alt="">
                </div>
                <div>
                    <img class="h-auto max-w-full rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/masonry/image-4.jpg" alt="">
                </div>
            </div>
            <div class="grid gap-2">
                <div class="relative">
                    <img class="h-auto w-full object-cover rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/masonry/image-6.jpg" alt="">
                </div>
                <div class="relative">
                    <img class="h-auto w-full object-cover rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/masonry/image-7.jpg" alt="">
                </div>
            </div>
            
            <div class="grid gap-2">

                <div class="relative group">
                    <img class="h-auto w-full object-cover rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/masonry/image-9.jpg" alt="">
                    <!-- Text and Button (hidden initially) -->
                    <div class="absolute bottom-0 left-0 right-0 text-white rounded-lg bg-table-dark opacity-0 group-hover:opacity-100 transition-opacity duration-300 p-4 flex justify-between items-center">
                        <span class="text-lg">Image Description</span>
                        <a href="#" class="bg-blue-700 hover:bg-blue-800 text-white font-medium py-2 px-4 rounded-lg text-sm">View More</a>
                    </div>
                </div>
            
                
                <div class="relative group">
                    <img class="h-auto w-full object-cover rounded-lg" src="https://flowbite.s3.amazonaws.com/docs/gallery/masonry/image-4.jpg" alt="">
                    <!-- Text and Button (hidden initially) -->
                    <div class="absolute bottom-0 left-0 right-0 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 p-4 flex justify-between items-center">
                        <span class="text-lg">Image Description</span>
                        <a href="#" class="bg-blue-700 hover:bg-blue-800 text-white font-medium py-2 px-4 rounded-lg text-sm">View More</a>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    
    <main class="mx-6 lg:mx-24 mt-20">
        <div class="font-Custom text-dark leading-tight">
            <h1 class="text-mobile-h3 font-semibold lg:text-destop-h1">Latest Auction</h1>
        </div>

        <div class="grid gap-6 mt-6 font-Custom place-content-start lg:grid-cols-3 grid-cols-1 text-dark">
            <% auctions.forEach(auction => { %>
                <!-- component -->
                <div class="mx-auto w-80 transform overflow-hidden rounded-lg bg-white shadow-md duration-300 hover:scale-105 hover:shadow-lg">
                    <img class="h-48 w-full object-cover object-center" src="<%= auction.images[0] %>" alt="Product Image" />
                    <div class="p-4">
                        <h2 class="mb-2 text-lg font-medium"><%= auction.title %></h2>
                        <p class="mb-2 text-base text-gray-700">Product description goes here.</p>
                        <div class="flex gap-2 flex-col items-start">
                            <!-- <p class="mr-2 text-lg font-semibold text-gray-900 dark:text-white">₹<%= auction.current_bid %></p> -->
                            <p>Current Bid:₹<span id="current-bid-<%= auction._id %>"><%= auction.current_bid %></span></p>
                            <p>Next Bid:₹<span id="next-bid-<%= auction._id %>"><%= auction.current_bid+auction.bid_increment %></span></p>
                        </div>
                        <button class="w-full h-10 text-white font-Custom mt-3 bg-primary w-50 rounded-lg" onclick="placeBid('<%= auction._id %>', '<%= auction.bid_increment %>' , '<%= userId %>')">Place Bid</button>
                    </div>
                </div>
            <% }) %> 
        </div>
    </main>


    <!-- upcoming auction -->
    <main class="mx-6 lg:mx-24 mt-12">
        <div class="font-Custom text-dark leading-tight">
            <h1 class="text-mobile-h3 font-semibold lg:text-destop-h1">Upcoming Auction</h1>
        </div>

        <div class="grid gap-6 mt-6 font-Custom place-content-start lg:grid-cols-3 grid-cols-1 text-dark">
            <% upcomingAuctions.forEach(auction => { %>
                <div class="mx-auto w-80 transform overflow-hidden rounded-lg bg-white shadow-md duration-300 hover:scale-105 hover:shadow-lg">
                    <img class="h-48 w-full object-cover object-center" src="<%= auction.images[0] %>" alt="Upcoming Auction Image" />
                    <div class="p-4">
                        <h2 class="mb-2 text-lg font-medium"><%= auction.title %></h2>
                        <p class="mb-2 text-base text-gray-700"><%= auction.description %></p>
                        <p>Starting Bid: ₹<%= auction.starting_bid %></p>
                        <p>Auction Date: <%= new Date(auction.start_time).toLocaleString() %></p>
                        <% if (auction.waiting_list.includes(userId)) { %>
                            <button id="btn-waitlist-<%= auction._id %>" class="w-full h-10 text-black font-Custom mt-3 border-2 border-primary rounded-desktop-form" disabled>Already on Waiting List</button>
                        <% } else { %>
                            <button id="btn-waitlist-<%= auction._id %>" class="w-full h-10 text-white font-Custom mt-3 bg-primary rounded-lg" onclick="joinWaitingList('<%= auction._id %>')">Join Waiting List</button>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        </div>
    </main>











    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
    
        function placeBid(auctionId, bidIncrement, userId) {
            // Log the user ID and bid increment to verify they're passed correctly
            console.log("User ID:", userId);
            console.log("Bid Increment (before parsing):", bidIncrement);
        
            // Parse the bidIncrement to ensure it's a number
            const parsedBidIncrement = parseFloat(bidIncrement);
            if (isNaN(parsedBidIncrement)) {
                console.error("Invalid bid increment:", bidIncrement);
                alert("Invalid bid increment");
                return;
            }
        
            // Get the current bid amount from the HTML and parse it
            const currentBidElement = document.getElementById(`current-bid-${auctionId}`);
            const currentBid = parseFloat(currentBidElement.textContent);
            
            if (isNaN(currentBid)) {
                console.error("Invalid current bid:", currentBidElement.textContent);
                alert("Invalid current bid");
                return;
            }
            
            console.log("Current Bid:", currentBid);
            
            // Calculate the next bid by adding the current bid and the bid increment
            const nextBidAmount = currentBid + parsedBidIncrement;
            console.log("Next Bid Amount:", nextBidAmount);
            
            // Update the UI with the next bid value in the new element
            const nextBidElement = document.getElementById(`next-bid-${auctionId}`);
            nextBidElement.innerText = `Next Bid: ${nextBidAmount}`;
            
            // Optionally: update the current bid immediately (only if the user places a bid)
            // currentBidElement.innerText = nextBidAmount;
            
            // Emit the new bid using Socket.IO
            socket.emit('placeBid', { auctionId, userId, bidAmount: nextBidAmount });
        }
    
        // Listen for bid updates from the server
        socket.on('bidUpdated', ({ auctionId, bidAmount }) => {
            const currentBidElement = document.getElementById(`current-bid-${auctionId}`);
            currentBidElement.innerText = bidAmount;
    
            // Optionally, you can also update the next bid value here
            const nextBidElement = document.getElementById(`next-bid-${auctionId}`);
            nextBidElement.innerText = `${parseFloat(bidAmount) + bidAmount/10}`;  // Adjust as per bid increment
        });
    
        // Listen for errors from the server
        socket.on('error', (message) => {
            alert(message);
        });
    </script>
    
    
    <script>
        async function joinWaitingList(auctionId) {
            try {
                const response = await fetch(`/join-waiting-list/${auctionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
    
                if (response.ok) {
                    // Change button text and style after joining the waiting list
                    const button = document.getElementById(`btn-waitlist-${auctionId}`);
                    button.innerText = 'Already on Waiting List'; // Update button text
                    button.classList.remove('bg-primary'); // Remove primary background
                    button.classList.add('bg-gray-500'); // Change to gray background
                    button.disabled = true; // Disable the button after adding
                } else {
                    const errorMessage = await response.text();
                    alert(errorMessage); // Show error message if any
                }
            } catch (error) {
                console.error('Error joining waiting list:', error);
                alert('Failed to join waiting list. Please try again.'); // Show alert on failure
            }
        }
    </script>
    
    
      
</body>
</html>